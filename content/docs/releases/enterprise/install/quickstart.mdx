---
# cSpell:ignore pygpgme makecache disablerepo enablerepo

title: Quickstart
description: Demo Pomerium Enterprise
sidebar_position: 1
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import GenerateRecoveryToken from '@site/content/_generate-recovery-token.md';

# Pomerium Enterprise Quickstart

Learn how to run Pomerium Enterprise using Docker containers.

## Prerequisites
To complete this guide, you need:

- Pomerium Core
- A configured identity provider
- [Docker](https://docs.docker.com/get-docker/) and [Docker Compose](https://docs.docker.com/compose/install/)
- PostgreSQL
- Prometheus

This guide runs Pomerium Core and PostgreSQL as Docker containers. If you haven't, pull the [Pomerium](https://hub.docker.com/r/pomerium/pomerium) and [PostgreSQL](https://hub.docker.com/_/postgres) Docker images from Docker Hub and complete the [Pomerium Core quickstart](/docs/quickstart) to set up a Pomerium instance that's compatible with this guide.

The Pomerium Enterprise Console uses an embedded Prometheus server to collect and display metrics. While you can [configure metrics](/docs/capabilities/metrics) to use an existing Prometheus server, this guide uses Pomeriumâ€™s Prometheus backend.

:::tip **Note**

This guide assumes you've already registered for Pomerium Enterprise and have credentials to access the private Cloudsmith Docker registry. If you haven't registered for Pomerium Enterprise, [sign up here](https://www.pomerium.com/enterprise-sales/) for a free trial.

:::

### Configure Docker Compose services

In your `docker-compose.yaml` file, define a bridge network:

```yaml title="docker compose"
version: "3"
networks:
  main: {}
```

In this guide, all the services defined in your Docker Compose config file will communicate over the `main` network.

### Configure Pomerium Core

Add the `pomerium` image to your `docker-compose.yaml` file:

```yaml title="pomerium service"
version: "3"
networks:
  main: {}
services:
  pomerium:
    image: pomerium/pomerium:latest
    volumes:
      - ./config.yaml:/pomerium/config.yaml:ro
    ports:
      - 443:443
    networks:
      main:
        aliases:
        - authenticate.localhost.pomerium.io
```

If you completed the Pomerium Core quickstart, your configuration should look similar to `pomerium service`.

However, note that `pomerium service` also defines the alias `authenticate.localhost.pomerium.io`. Defining a container's alias allows other services to communicate with it by that name.

### Configure Pomerium Enterprise Console

Under the `pomerium` service, add the configuration for `pomerium_console`:

```yaml title="pomerium console"
  pomerium_console:
    networks:
      main:
    depends_on:
      database:
        condition: service_healthy
      pomerium:
        condition: service_started
    image: docker.cloudsmith.io/pomerium/enterprise/pomerium-console:v0.20.0
    expose:
      - 8701
      - 9090
    volumes:
      - ./pomerium/metrics:/data:rw
      - ./console-config.yaml:/pomerium/config.yaml:ro
```

**Here's what the `pomerium_console` service is doing:**

The `pomerium console` depends on the following services before the container will run:
- A database connection (in this case, PostgreSQL)
- A running instance of the Pomerium Core service

Once the container runs, it exposes ports `8701` and `9090`. Later, you will define port `8701` in a route that connects to the Pomerium Enterprise Console. Port `9090` is the [default port](https://prometheus.io/docs/introduction/first_steps/#configuring-prometheus) used by Prometheus to scrape metrics.

Lastly, `pomerium_console` mounts the following files to persist data between sessions:
- `./pomerium/metrics:/data:rw`
- `./console-config.yaml:/pomerium/config.yaml:ro`

### Configure the PostgreSQL database

Under the `pomerium_console` service, add the configuration for `postgres`:

```yaml database service
  database:
    networks:
      main: {}
    image: postgres:latest
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d postgres -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 30s
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports:
      - 5432:5432
    volumes:
      - ./pgdata:/var/lib/postgresql/data
```

**Here's what the `database` service is doing:**

`restart: always` closes your database connection when you kill the container and restarts the connection when you run `docker compose up`.

The `healthcheck` parameter ensures the database is ready to receive requests. Without a healthcheck, other containers that depend on the database service (like Pomerium Console) will attempt to connect to the database before it is in a ready state, which will crash the container. (See the [Docker healthcheck docs](https://docs.docker.com/engine/reference/builder/#healthcheck) for more information.)

The `environment` variables define the database user, password, and name, and ports `5432` connects your local port to the container port (`5432` is the default PostgreSQL port).

You must also mount `pgdata` to `/var/lib/postgresql/data` to persist data or to import existing data into your container instance.

### Configure the Verify service

Add the configuration for the final service to, `verify`:

```yaml title="verify"
  verify:
    networks:
      main: {}
    image: pomerium/verify:latest
    expose:
      - 8000
    restart: always
```

TODO: write out this section


#############################END NEW GUIDE

## Before You Begin

This document assumes:

- A non-containerized environment, either your local computer or a virtual machine (**vm**). While Pomerium is designed to scale with your production environment, we'll leave containerization and infrastructure as code (**IaC**) out for now, to focus on learning how Pomerium Enterprise works.
  - `root` or `sudo` privileges on the host.
- You already have the open-source Pomerium base installed. If not, follow [this doc](/docs/releases/core) before you continue.
  - While an existing route is not required, we suggest implementing one test route to validate your identity provider (**IdP**) configuration.
- Pomerium Enterprise requires a relational database. PostgreSQL 9+ is supported.
  - Securing the database connection with TLS may not be required, especially for a local installation, but is strongly recommended for production deployments. Therefore, this guide will assume a TLS-secured database connection.

## Requirements

- Pomerium Enterprise requires Linux amd64/x86_64. It can manage Pomerium instances on other platforms, however.
- Each Console instance should have at least:
  - 4 vCPUs
  - 8G RAM
  - 100G of disk wherever logs are stored
- Each Postgres instance should have at least:
  - 4 vCPUs
  - 8G RAM
  - 20G for data files

## Install Pomerium Enterprise

Pomerium publishes standard OS packages for RPM and DEB based systems. The repositories require authentication via username and access key. These credentials will be issued to you during the onboarding process.

<Tabs>

<TabItem value="deb" label="deb">

1. To automatically configure the repository for Debian and Ubuntu distributions, run the following command replacing `[access-key]`:

   ```bash
   curl -1sLf \
   'https://dl.cloudsmith.io/[access-key]/pomerium/enterprise/setup.deb.sh' \
   | sudo -E bash
   ```

   Or to manually configure, you can manually import the apt key, then create a new `.list` file in `/etc/apt/source.list.d`. Make sure to replace the distribution and version:

   ```bash
   curl -1sLf 'https://dl.cloudsmith.io/[access-key]/pomerium/enterprise/gpg.B1D0324399CB9BC3.key' | apt-key add -

   echo "deb https://dl.cloudsmith.io/[access-key]/pomerium/enterprise/deb/debian buster main" | sudo tee /apt/sources.list.d/pomerium-console.list
   ```

1. Update `apt` and install Pomerium Enterprise:

   ```bash
   sudo apt update; sudo apt install pomerium-console
   ```

</TabItem>

<TabItem value="yum" label="yum">

1. To automatically configure the repository for RHEL based distributions, run the following command replacing `[access-key]`:

   ```bash
   curl -1sLf \
   'https://dl.cloudsmith.io/[access-key]/pomerium/enterprise/setup.rpm.sh' \
   | sudo -E bash
   ```

   Or to manually configure:

   ```bash
   yum install yum-utils pygpgme
   rpm --import 'https://dl.cloudsmith.io/[access-key]/pomerium/enterprise/gpg.B1D0324399CB9BC3.key'
   curl -1sLf 'https://dl.cloudsmith.io/[access-key]/pomerium/enterprise/config.rpm.txt?distro=el&codename=8' > /tmp/pomerium-enterprise.repo
   yum-config-manager --add-repo '/tmp/pomerium-enterprise.repo'
   yum -q makecache -y --disablerepo='*' --enablerepo='pomerium-enterprise'
   ```

1. Update refresh and install:

   ```bash
   yum -y install pomerium-console
   ```

</TabItem>

</Tabs>

### System Service

Once the package is installed, enable and start the system service:

```bash
sudo systemctl enable --now pomerium-console
```

## Initial Configuration

Like the open-source Pomerium base, Pomerium Enterprise is configured through a single config file, located at `/etc/pomerium-console/config.yaml`.

### Update Pomerium

Open your Pomerium config file, `/etc/pomerium/config.yaml`.

1. Add a list item in the `routes` block for the Enterprise Console:

   ```yaml title="/etc/pomerium/config.yaml"
   routes:
     - from: https://console.localhost.pomerium.com
       to: https://localhost:8701
       policy:
         - allow:
             or:
               - domain:
                   is: example.com
       pass_identity_headers: true
   ```

   The example value for `to:` assumes Pomerium and Pomerium Enterprise are running on the same test environment.

1. If you haven't already, set `signing_key`. See the [reference page](/docs/reference/signing-key) for more information. The same signing key must be used in both Pomerium Core and Enterprise.

   ```yaml title="/etc/pomerium/config.yaml"
   signing_key: 'ZZZZZZZZZZZZZZ'
   ```

1. Define the [databroker](/docs/reference/data-broker-service) storage type and connection string. The example below assumes a local Postgres server:

   ```yaml title="/etc/pomerium/config.yaml"
   databroker_storage_type: postgres
   databroker_storage_connection_string: postgres://user:pass@dbhost.internal.mydomain.com/pomerium?sslmode=require
   ```

With these changes made to Pomerium Core, we can begin editing the Pomerium Console configuration.

### External Services

First configure the Console to communicate with the database and databroker service:

```yaml title="/etc/pomerium-console/config.yaml"
database_url: postgres://user:pass@dbhost.internal.mydomain.com/pomerium?sslmode=require
databroker_service_url: https://pomerium-cache.internal.mydomain.com
shared_secret: XXXXXXXXXXXXXXXXXXX
database_encryption_key: YYYYYYYYYYYYYYYYYYYYYY
```

For database uri options (especially TLS settings) see the [PostgreSQL SSL Support](https://www.postgresql.org/docs/9.1/libpq-ssl.html) documentation.

### Administrators

As a first-time setup step, you must also configure at least one administrator for console access. This user (or users) can then configure additional administrators in the console UI.

```yaml title="/etc/pomerium-console/config.yaml"
administrators: you@mydomain.com
```

Once you have set permissions in the console UI, you should remove this configuration.

### TLS, Signing Key and Audience

1. If your open-source Pomerium installation is already configured to use TLS to secure back-end communication, you can do the same for Pomerium Enterprise by providing it a certificate, key, and optional custom CA file to validate the `databroker_service_url` connection:

   ```yaml title="/etc/pomerium-console/config.yaml"
   tls_ca_file: /etc/pomerium-console/ca.pem
   tls_cert_file: /etc/pomerium-console/cert.pem
   tls_key_file: /etc/pomerium-console/key.pem
   ```

   For proof-of-concept installations in the same local system, this is not required.

1. Set the [`signing_key`](/docs/reference/signing-key) to match Pomerium's.

1. Set the `audience` key to match the `from` domain value from your [Pomerium configuration](#update-pomerium), excluding protocol:

   ```yaml title="/etc/pomerium-console/config.yaml"
   audience: console.localhost.pomerium.com
   ```

   This sets the expected "audience" key in the [JWT header](/docs/reference/jwt-claim-headers) to match what's provided by open-source Pomerium as it proxies traffic to the Enterprise Console UI.

### License Key

Finally, add your license key to the configuration file:

```yaml title="/etc/pomerium-console/config.yaml"
license-key: YOUR_LICENSE_KEY
```

---

Once complete, your `/etc/pomerium-console/config.yaml` file should look something like this:

```yaml title="/etc/pomerium-console/config.yaml"
database_url: postgres://user:pass@dbhost.internal.mydomain.com/pomerium?sslmode=require
databroker_service_url: https://pomerium-cache.internal.mydomain.com
shared_secret: 'XXXXXXXXXXXXXXXXXXX'
database_encryption_key: 'YYYYYYYYYYYYYYYYYYYYYY'

# change / remove this after initial setup
administrators: you@mydomain.com

tls_ca_file: /etc/pomerium-console/ca.pem
tls_cert_file: /etc/pomerium-console/cert.pem
tls_key_file: /etc/pomerium-console/key.pem

signing_key: 'ZZZZZZZZZZZZZZ'

audience: console.localhost.pomerium.com

license-key: YOUR_LICENSE_KEY
```

## Next Steps

Pomerium Enterprise assumes access to a [Prometheus](https://prometheus.io/) data store for metrics. See [Configure Metrics](/docs/capabilities/metrics) to learn how to configure access.

## Troubleshooting

### Generate Recovery Token

<GenerateRecoveryToken />
