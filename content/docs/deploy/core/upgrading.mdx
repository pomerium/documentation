---
# cSpell:ignore privkey cooldown certbot httpchk autocache forwardauth signin healthcheck GITHASH

title: Upgrading
description: >-
  This page contains the list of deprecations and important or breaking changes for Pomerium. Please read it carefully.


pagination_prev: null
pagination_next: null
sidebar_position: 10
---

# Upgrade guide

## 0.25.0

### Breaking

#### Base64-encoded Certificates

Previously, the `certificates` key supported base64-encoded certificates as a value (this option was not documented). We've removed support for base64-encoded certificates for this setting and now require that you only use the certificate file location. To avoid incompatibilities between versions, please update these values accordingly.

**Note:** The `certificates` key is distinct from the `certificate` key. The `certificate` key setting still supports base64-encoded certificates; the `certificates` _list_ does not.

#### Remove Debug Option

We've removed support for the Debug setting, which changed the format of logs from JSON to a pretty-print format. If you prefer to review logs in a pretty-print format, you can use a command-line processing tool like `jq`.

### New

#### Authentication Flows

In v0.21, we modified the Core authentication flow to support the [Hosted Authenticate](https://www.pomerium.com/docs/capabilities/hosted-authenticate-service) service. However, this flow posed some limitations for self-hosted deployments (see [#4819](https://github.com/pomerium/pomerium/issues/4819) for more details). In v0.25, we’ve updated the Core authentication flow so that it’s more versatile: Deployments configured to use the Hosted Authenticate service will use the newer authentication flow introduced in v0.21, while self-hosted deployments will use the older flow.

## 0.24.0

### Breaking

#### Set Authorization Header

The deprecated `set_authorization_header` configuration setting has been removed. You can use the [Set Request Headers](/docs/reference/routes/headers#set-request-headers) setting to pass IdP tokens to upstream services in any header.

#### Base64-encoded Certificates

Previously, the `certificates` key supported base64-encoded certificates as a value (this option was not documented). We've removed support for base64-encoded certificates for this setting and now require that you only use the relative file location.

**Note:** The `certificates` key is distinct from the `certificate` key. The `certificate` key setting still supports base64-encoded certificates; the `certificates` _list_ does not.

See [Certificates](/docs/reference/certificates#certificates) for more information.

#### Redis Storage Backend

PostgreSQL has been the recommended databroker storage backend since v0.18. Support for Redis has now been removed.

See [Persistence](/docs/internals/data-storage#postgres) for more information.

### Performance

v0.24.0 includes several performance enhancements for Pomerium Core. See the sections below for more information.

#### Policy evaluator reuse

The authorize service maintains one policy evaluator object for each route, which is responsible for all authorization decisions for that route.

Previously, the authorize service would recreate all policy evaluator objects in response to a configuration change.

Now, it will avoid recreating policy evaluator objects for any policies that have not changed, provided that the overall settings are compatible between the old and new configuration. (Some settings affect all routes, e.g. the [downstream_mtls](https://www.pomerium.com/docs/reference/downstream-mtls-settings) options, and changes to these options will still require all policy evaluators to be recreated.)

#### Parallelization

Core will now build route configuration objects and policy evaluator objects in parallel, each using up to half the number of available CPU cores.

## 0.23.0

### New

#### Logging Configurations

The new [Access Log Fields](/docs/reference/access-log-fields) and [Authorize Log Fields](/docs/reference/authorize-log-fields) settings allow you to customize the fields logged in the access and authorize logs. You can now opt to log ID tokens or specific ID token claims, custom request headers, and the request query params. See the linked reference pages for details.

<details>
  <summary>How the new Logging Configurations work</summary>
  <div>

**1. Configure logs**<br/> Specify which fields you want to log (omitting the setting will display all the default fields):

```yaml
# Access logs from Proxy service
access_log_fields:
  - authority
  - path

# Authorize logs from Authorize service
authorize_log_fields:
  - request-id
  - method
  - path
```

**2. Access a route**<br/> For example, Pomerium’s Verify service:

```yaml
routes:
  - from: https://verify.localhost.pomerium.io
    to: http://verify:8000
```

**3. Find logs**<br/> After you access a route, filter your logs by searching for `“http-request”` and `“authorize check”`:

```json
// Search for “message”: “http-request”
{
  "level": "info",
  "service": "envoy",
  "authority": "verify.pomerium.com",
  "path": "/img/json.svg",
  "time": "2023-08-04T12:12:35-04:00",
  "message": "http-request"
}
// Search for “message”: “authorize check”
{
  "level": "info",
  "service": "authorize",
  "request-id": "c9afae5a-ec5a-4242-864f-df4189f20e99",
  "method": "GET",
  "path": "/index.css",
  "allow": true,
  "allow-why-true": ["domain-ok"],
  "deny": false,
  "deny-why-false": [],
  "time": "2023-08-07T10:26:33-04:00",
  "message": "authorize check"
}
```

  </div>
</details>

#### New Downstream mTLS Settings

Downstream mTLS refers to the requirement that end users connecting to Pomerium-managed routes must present a trusted client certificate. The options for configuring downstream mTLS have been expanded and moved to a new settings group, under a new `downstream_mtls` configuration file key.

The existing [Certificate Authority](/docs/reference/downstream-mtls-settings#ca) setting has moved from `client_ca` to `downstream_mtls.ca`. The `client_ca` configuration file key will continue to function as an alias for the new setting (but will be removed in a future release).

Support for certificate revocation via CRLs is newly introduced. Please see the [CRL](/docs/reference/downstream-mtls-settings#crl) reference for more information and some important limitations.

A new [Enforcement Mode](/docs/reference/downstream-mtls-settings#enforcement-mode) option has been added, to control the behavior when a client does not present a trusted certificate. The default setting preserves the behavior of previous Pomerium releases: client certificates are required only for user-configured Pomerium routes, and Pomerium will serve an HTML error page for requests without a trusted certificate. The new `reject_connection` setting allows for stricter client certificate enforcement: in this mode any attempt to make a TLS connection without a trusted client certificate will be rejected. Naturally, this means that client certificates will be required not only for user-configured Pomerium routes, but also for internal Pomerium routes. This mode allows you to use mTLS as an isolated security layer, entirely separate from Pomerium policy enforcement. Please review the [reference page](/docs/reference/downstream-mtls-settings#enforcement-mode) carefully before enabling this mode.

To give further control over which specific client certificates are allowed, Pomerium now also offers a [Match Subject Alt Names](/docs/reference/downstream-mtls-settings#match-sans) setting. This allows you to trust only those client certificates containing a Subject Alternative Name (SAN) of a specific type, matching a particular regular expression.

When the new [Max Verify Depth](/docs/reference/downstream-mtls-settings#max-verify-depth) option is set, Pomerium will consider client-supplied intermediate CA certificates when verifying a client certificate. The default setting preserves the behavior of previous Pomerium releases: all client certificates must be issued directly by a certificate authority included in the CA setting (no client-supplied intermediate CA certificates are allowed). This default behavior may change in a future release.

#### Certificate Matcher PPL Criteria (beta)

The new [Certificate Matcher](/docs/capabilities/ppl#certificate-matcher) can be used with the new PPL criterion `client_certificate` to build policies that grant or deny access based on the client certificate’s fingerprint or Subject Public Key Info (SPKI) hash. Both of these options allow you to create an allowlist or denylist of specific certificates.

See the [Certificate Matcher](/docs/capabilities/ppl#certificate-matcher) policy page for more information and examples.

#### Set Request Headers options

You can configure the [Set Request Headers](/docs/reference/routes/headers#pass-dynamic-tokens-in-headers) setting to send the client certificate fingerprint (downstream mTLS must be enabled) to the upstream application or service. The fingerprint can be built into your authorization policy with the new Certificate Matcher (beta) PPL criteria to grant or deny users based on the fingerprint’s value.

See the [Set Request Headers](/docs/reference/routes/headers#pass-dynamic-tokens-in-headers) settings page for more information and examples.

### Deprecated

#### Set Authorization Header

The [Set Authorization Header](/docs/reference/routes/headers#set-authorization-header) option is deprecated in favor of the new variable substitution support in the Set Request Headers option. This new support allows you to pass IdP tokens to upstream services in any header, not just the `Authorization` header.

The Set Authorization Header option will be removed in a future release.

#### TLS Downstream Client Certificate Authority

The [TLS Downstream Client Certificate Authority](/docs/reference/routes/tls#tls-downstream-client-certificate-authority) option is deprecated, and will be removed in a future release.

If you previously used this setting to require client certificates only on certain routes, you can achieve this same behavior by setting the new downstream mTLS [Enforcement Mode](/docs/reference/downstream-mtls-settings#enforcement-mode) option to the value `policy` and adding a policy deny rule with the `invalid_client_certificate` criterion on all routes that should require client certificates.

If you want to enforce an allowlist or denylist of specific certificates on a particular route, you can use the new [`client_certificate`](/docs/capabilities/ppl#certificate-matcher) policy criterion.

If you do need to set completely different trusted client CAs for different routes, we recommend running separate Pomerium clusters for each set of trusted client CAs.

### Breaking

#### Set Request Headers options

To prevent a ‘$’ character from being treated as the start of a variable substitution, you may need to replace it with ‘$$’.

## 0.22.0

### New

#### Hosted Authenticate Service

- [Hosted Authenticate Service](/docs/capabilities/hosted-authenticate-service.md) will now be used by default to handle single-sign-on. Pomerium hosts this service as a convenience to its users; no identity provider configuration or authenticate service URL needs to be specified if the hosted authenticate service is used. The [Self-Hosted Authenticate Service](/docs/capabilities/self-hosted-authenticate-service), which requires a self-hosted authenticate service URL and identity provider, is still supported for users that prefer to host these services themselves.

#### Wildcard From Routes

- [Wildcard From Routes](/docs/reference/routes/from#wildcard-from-routes) is a Beta support feature that allows you to define a wildcard route that points matching external routes to a single destination.

#### Better Memory performance

- Internal [RDS changes](https://github.com/pomerium/pomerium/pull/4098) reduce memory consumption, especially for environments where configuration changes rapidly.

## 0.21.0

### Upgrading

There are several data model changes in this release that are not backward compatible. Please make sure you back up your Postgres database before performing an upgrade.

### Breaking

#### Devices need to be re-enrolled

The [Device Identity (beta)](/docs/capabilities/device-identity) data model had an internal change that is not forward compatible. Your enrolled devices will need be re-registered. Your existing policies may need to be updated.

#### Forward Auth (deprecated, removed in this release)

Forward auth was introduced in early versions of Pomerium to provide a gradual migration path for users of other reverse proxies to Pomerium. Since then, Pomerium has come a long way - it is now based around first class reverse proxy core (Envoy) and has been battle tested for many years. Unfortunately, supporting forward authentication mode provides a subpar experience in security (cookies cannot be stripped from upstream requests), configuration (misconfiguration issues are common and hard to troubleshoot), and it is not compatible with many of Pomerium's newer features and deployment scenarios.

### New

#### Bastion Host support for TCP routes

See [Bastion Host](/docs/capabilities/tcp#bastion-host)

#### Internal TLS by default

If you run Pomerium Enterprise, you may set up a secure HTTPS connection between Pomerium Core and Enterprise without need to explicitly supply certificates. See [`tls_derive`](/docs/reference/tls-derive)

## 0.20.0

### Breaking

#### IdP Groups Policy

A deprecated `routes.allowed_groups` and `groups` PPL criteria were removed.

For Open Source, please use IdP Claims passed by your IdP.

- Please visit your IdP provider admin console to adjust group membership propagation to Claims.
  - [Okta](https://developer.okta.com/docs/guides/customize-tokens-groups-claim/main)
  - [Auth0](https://auth0.com/docs/customize/extensions/authorization-extension/configure-authorization-extension#add-authorization-information-to-the-token-issued)
  - [Azure](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-fed-group-claims)
  - [Cognito](/docs/identity-providers/cognito.html#group-based-policies)
- You may need adjust requested scopes via `idp_scopes` config option.
- visit your authenticate endpoint `/.pomerium` route to check the group claims are passed by your IdP.
- use `claim/` [PPL criteria](/docs/capabilities/ppl.html#criteria)

```yaml
routes:
  - from: https://httpbin.localhost.pomerium.io
    to: https://httpbin.org
    pass_identity_headers: true
    policy:
      allow:
        and:
          - claim/groups: admins
```

For Enterprise, use PPL Builder ![policy_groups_enterprise](../enterprise/img/upgrading/policy_groups_enterprise.png)

### IdP Directory Sync

IdP directory sync has been moved to https://github.com/pomerium/datasource and becomes part of the [External Data Sources integration](/docs/integrations/), in order to provide unification with other external data sources, consolidate job scheduling and monitoring.

Setting the below options in Pomerium config file would now result in an error. In Pomerium Enterprise Console, please navigate to Settings > Identity Provider and configure directory sync there.

- `idp_service_account`: use IdP provider specific options in the UI.
- `idp_refresh_directory_timeout`: use [Polling Min Delay](/docs/deploy/enterprise/configure#polling-minmax-delay).
- `idp_refresh_directory_interval`: replaced by [Polling Max Delay](/docs/deploy/enterprise/configure#polling-minmax-delay).
- `idp_qps`: not required, IdP providers adjust their qps rate.

Pomerium Core would only perform user authentication and session refresh with the IdP provider, and would not try to synchronize user details and groups, which is now part of [External Data Sources](/docs/integrations/).

![idp_enterprise](../enterprise/img/upgrading/policy_groups_enterprise.png)
