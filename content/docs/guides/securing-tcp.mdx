---
# cSpell:ignore myuser

title: Securing TCP based services
lang: en-US
keywords:
  [
    pomerium,
    identity access proxy,
    ssh,
    tcp,
    postgres,
    database,
    redis,
    mysql,
    tcp-forwarding,
  ]
description: This guide covers how to use Pomerium to protect TCP services such as SSH, Postgres and Redis.
---

import PomeriumConfig from '../../examples/tcp/config.yaml.md';
import DockerCompose from '../../examples/tcp/docker-compose.yaml.md';

# Securing TCP based services

The following guide demonstrates how to use Pomerium's [TCP Proxying](/docs/capabilities/tcp) support with various TCP services such as databases and other non-HTTP protocols. It also covers integration points with them when possible.

The source files from this guide can be found on [GitHub](https://github.com/pomerium/pomerium/tree/main/examples/tcp/).

## Background

When replacing a traditional VPN, there are often non-HTTP based applications which must still be reachable. Pomerium is able to provide the same type of protection to these services by using a client side application to proxy TCP connections. Authentication and authorization configuration is shared with standard HTTP routes, and the underlying transport is still encrypted between the end-user and Pomerium.

Important notes:

- Pomerium authorizes HTTP on a request-by-request basis, but TCP is authorized on a per-connection basis.
- Pomerium is only authorizing the TCP _connection_. It does not interact with application level authorization systems at this time.

## How it works

- Create a standard Pomerium configuration for your [identity provider (IdP)](/docs/identity-providers)
- `pomerium-cli` runs on your workstation, listening on loopback for TCP connections
- When an inbound connection is made, `pomerium-cli` proxies the connection through `pomerium`, authenticating the user if needed
- Pomerium authorizes the connection and forwards it to the upstream service
- The connecting application functions as normal

## Pre-requisites

This recipe is designed to run on a local docker-compose instance. The included configuration can be adopted for any TCP service, however.

- docker
- docker-compose
- A copy of the [example repo](https://github.com/pomerium/pomerium/tree/main/examples/tcp/) checked out
- Valid credentials for your OIDC provider
- The [Pomerium Client](/docs/deploy/clients/pomerium-cli) installed
- (Optional) `mkcert` to generate locally trusted certificates

## Certificates (optional)

This demo comes with its own certificates, but `pomerium-cli` and your browser will not trust them by default. You may instead provide your own or use [mkcert](https://github.com/FiloSottile/mkcert) to generate locally trusted certificates.

After installing `mkcert`, run the following inside the example repo:

```bash
mkcert -install
   mkcert '*.localhost.pomerium.io'
```

This will install a trusted CA and generate a new wildcard certificate:

- `_wildcard.localhost.pomerium.io.pem`
- `_wildcard.localhost.pomerium.io-key.pem`

To provide your own certificates through another mechanism, please overwrite these files or update `docker-compose.yaml` accordingly.

## Configure

### Pomerium

Update `config.yaml` with your IdP settings and desired policy if adopting for your environment

<PomeriumConfig />

### Docker Compose

Create a `docker-compose.yaml` file to run Pomerium and, optionally, the services being demonstrated.

Included in our compose file:

- SSH
- Postgres
- Redis

<DockerCompose />

## Connect

To connect to your service, ensure [`pomerium-cli`](/docs/deploy/clients/pomerium-cli) is in your `$PATH` and run the `tcp` command, specifying the service you wish to reach.

```bash
pomerium-cli tcp [hostname]:[port]
```

`pomerium-cli` will select a random port on `localhost` by default, but you can specify a port manually if desired. Keep reading for some specific application examples using the sample `docker-compose.yaml`.

## Redis

Start a proxy to redis in the background:

```shell-session
$ pomerium-cli tcp redis.localhost.pomerium.io:6379 --listen localhost:6379
2023/10/02 12:20:05 listening on 127.0.0.1:6379
```

Start the redis client:

```shell-session
$ redis-cli info
# Server
redis_version:7.0.5
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:d9291579292e26e3
redis_mode:standalone
os:Linux 6.3.13-linuxkit aarch64
arch_bits:64
monotonic_clock:POSIX clock_gettime
multiplexing_api:epoll
atomicvar_api:c11-builtin
gcc_version:10.2.1
process_id:1
process_supervised:no
run_id:e4c843df14511765f0e6284690be2f10c6b39e28
tcp_port:6379
server_time_usec:1696349965506132
uptime_in_seconds:75
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:1851149
executable:/data/redis-server
config_file:
io_threads_active:0
```

## Postgres

In our example docker-compose, we have configured `supersecret` as the password for the `postgres` user.

Start a proxy to postgres in the background:

```shell-session
$ pomerium-cli tcp pgsql.localhost.pomerium.io:5432 --listen localhost:5432
2023/10/03 12:22:08 listening on 127.0.0.1:5432
```

Connect and list the schemas after password authentication:

```shell-session
$  psql -h localhost -W -U postgres -c '\dn'
Password:
       List of schemas
   Name   |       Owner
----------+-------------------
 pomerium | postgres
 public   | pg_database_owner
(2 rows)
```

## SSH

SSH clients can make use of external programs to establish a connection to a host. Most frequently, this is for using an SSH jump host to reach a target system. However, any transport application can be used. `pomerium-cli`'s `tcp` command can be used in conjunction with this configuration. Read on to see how.

More Info:

- [https://man.openbsd.org/ssh_config.5#ProxyCommand](https://man.openbsd.org/ssh_config.5#ProxyCommand)
- [https://www.redhat.com/sysadmin/ssh-proxy-bastion-proxyjump](https://www.redhat.com/sysadmin/ssh-proxy-bastion-proxyjump)

### Setup

To configure your SSH client to use Pomerium's TCP support for SSH routes, create the following entry in your `ssh_config` or `~/.ssh/config`:

```
Host *.localhost.pomerium.io
    ProxyCommand pomerium-cli tcp --listen - %h:%p
```

- Be sure to substitute your domain for `localhost.pomerium.io`
- Be sure `pomerium-cli` is in your `$PATH`

### Connecting

Start a proxy to the SSH client in the background:

```shell-session
$ pomerium-cli tcp ssh.localhost.pomerium.io:22 --listen :2222
2023/10/03 12:29:17 listening on 127.0.0.1:50741
```

Initiate the SSH connection:

```shell-session
$ ssh myuser@ssh.localhost.pomerium.io -p 2222
myuser@ssh.localhost.pomerium.io's password:
Welcome to OpenSSH Server

4e737e02c43f:~$
```

That's it! A Pomerium proxy will be started _automatically_ whenever you ssh to a host under `localhost.pomerium.io`.

In our example Docker-Compose file, we have an SSH server configured with `supersecret` as the password for `myuser`.

