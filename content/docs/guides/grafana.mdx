---
title: Securing Grafana with Pomerium
sidebar_label: Grafana
lang: en-US
keywords:
  [
    pomerium,
    identity access proxy,
    data,
    logging,
    graphing,
    grafana,
    authentication,
    authorization,
  ]
description: This guide covers how to use Pomerium to authenticate and authorize users of Grafana.
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Grafana

Learn how to use Pomerium to authenticate and authorize users of Grafana.

## What is Grafana?

[Grafana](https://grafana.com/) is an open-source analytics visualization and monitoring tool. It provides many user-contributed [Dashboards](https://grafana.com/grafana/dashboards/) that make it popular for enthusiasts as well as professionals.

This guide will demonstrate how to secure an instance of Grafana behind Pomerium, and provide users with a seamless login to Grafana using your identity provider.

## Set up Grafana

This guide assumes you have administrator access to a working Grafana instance and write access to the [Grafana configuration file](https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/).

### Configure Grafana to use JWT authentication

You need to configure Grafana to enable JWT authentication. This makes it possible for Grafana to accept identity claims sent upstream by Pomerium.  

In your `grafana.ini` file, make the following changes:

```ini title="grafana.ini"
[auth]
signout_redirect_url = https://grafana.localhost.pomerium.io/.pomerium/sign_out
[auth.jwt]
enabled = true
header_name = X-Pomerium-Jwt-Assertion
email_claim = email
jwk_set_url = https://auth.localhost.pomerium.io/.well-known/pomerium/jwks.json
cache_ttl = 60m
```

Under `[auth]`:
- `signout_redirect_url` signs users out of Pomerium when they sign out of Grafana

Under `[auth.jwt]`:
- `enabled = true` enables JWT authentication (Grafana disables it by default)
- `header_name = X-Pomerium-Jwt-Assertion` tells Grafana which HTTP header to look at for the JWT (see [Identity Verification] for more information)
- `email_claim` associates the `email_claim` in the JWT with the email of the Grafana user
- `jwk_set_url` defines the URL with the signing key to validate the JWT
- `cache_ttl` sets a 60-minute cache time for the token

:::tip **Note**

In `jwk_set_url`, replace `auth.localhost.pomerium.io` with the value of [`authenticate_service_url`] in your Pomerium configuration. 

See the Pomerium Core [quick-start] guide for more information, or the [Enterprise quick-start](/docs/releases/enterprise/install/quickstart) if you're using Pomerium Enterprise.

:::

Once you've saved and exited the file, restart Grafana.

### Add users to Grafana

At this stage, Grafana is configured to use the `email` claim in the JWT to associate an incoming connection with a user (you will configure Pomerium to include identity information via the JWT in the next section). 

But, the user first must exist in Grafana to be associated. Otherwise, you will see the following error in the browser after authenticating:

```json
{"message": "User not found"}
```

To avoid this error, create a user with administrator privileges. (If you plan on administering Grafana through a direct connection to the service, skip this section.)

To add users without requiring them to accept an invitation:

1. Log in to Grafana directly as an admin user at `http://grafana.local:3000` (if this is your first time signing up for Grafana, `admin` is the [default username and password](https://grafana.com/docs/grafana/v9.0/setup-grafana/configure-grafana/#security))

1. Select **Server Admin**, **Users**

   ![The users option under the server admin menu](img/grafana-server-admin-users.png)

   :::caution 
   
   This is distinct from the **Users** option under the cog wheel (**Configuration**), which will only finalize a new user when they accept an invite via email or link. 
   
   :::

1. Select **New user** to create a new user. Make sure that the email address matches the one provided by Pomerium via your IdP.

   :::tip 
   
   You can access the special endpoint `/.pomerium` from any Pomerium route to view the data provided by Pomerium in the JWT. 
   
   :::

After creating a new user in Grafana, that user should be logged in automatically when they access Grafana from the Pomerium route (after first authenticating with your IdP, of course).

:::tip **Note**

See [Manage Access at Scale](#manage-access-at-scale) to enable Grafana's `auto_sign_up` capability to create users as needed.

:::

## Configure Pomerium

<Tabs>

<TabItem value="Core" label="Core">

To configure Pomerium Core, you need:

- [Docker](https://www.docker.com/) and [Docker Compose](https://docs.docker.com/compose/install/)
- A preconfigured [identity provider](/docs/identity-providers) (IdP)

See the Pomerium [quick-start] guide to run Pomerium in a containerized Docker environment.

:::tip **Note**

This guide uses [GitHub](/docs/identity-providers/github) as the preconfigured IdP, but you can use any supported IdP. 

:::

### Configure the Pomerium route

Add a route for Grafana to your Pomerium config. Change the following variables in the example below to match your setup:

| Variable | Description |
| :-- | --- |
| `localhost.pomerium.io` | The domain space where Pomerium is configured to set up routes. You can also change `grafana` to a custom subdomain. |
| `http://grafana:3000` | The hostname or IP address and port from which Grafana is accessible within your local network or container environment. |
| `example.com` | Your company domain. The example policy allows access to Grafana for anyone with an email address from your company domain. Adjust the policy to match your organization's needs. |

<Tabs>

<TabItem value="config.yaml" label="config.yaml">

For all-in-one or split service configurations using `config.yaml`, add the route to your `config.yaml` file:

```yaml title="config.yaml"
routes:
  - from: https://grafana.localhost.pomerium.io
    to: http://grafana:3000
    pass_identity_headers: true
    policy:
      - allow:
          or:
            - domain:
                is: example.com
```

:::tip **Note**

Docker-based installations may need to be restarted to pick up the new route.

:::

</TabItem>
<TabItem value="Ingress" label="Ingress">

If you're using the Pomerium Ingress Controller in Kubernetes, add an Ingress for the new route. Adjust the following example to match your configuration. Note that this example assumes a [cert-manager][ingress-cert-manager] solution for route certificates:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana
  annotations:
    cert-manager.io/issuer: pomerium-issuer
    ingress.pomerium.io/policy: '[{"allow":{"and":[{"domain":{"is":"example.com"}}]}}]'
    #ingress.pomerium.io/secure_upstream: true # Uncomment if Grafana is serving content over HTTPS
    ingress.pomerium.io/pass_identity_headers: 'true'
spec:
  ingressClassName: pomerium
  rules:
    - host: grafana.localhost.pomerium.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000
  tls:
    - hosts:
        - grafana.localhost.pomerium.io
      secretName: grafana.localhost.pomerium.io-tls
```

</TabItem>

</Tabs>

</TabItem>
<TabItem value="Enterprise" label="Enterprise">

TODO: Add Enterprise steps and screenshots

</TabItem>

</Tabs>

Once the new route is applied, users can access Grafana from `https://grafana.localhost.pomerium.io`

### Manage Access at Scale

:::tip Note Ensure that Grafana is up to date to take advantage of `auto_sign_up`, as it is only available for JWT as of version 8.4.0. :::

The steps outlined above work to confirm the configuration for small teams, but adding users individually and manually does not scale for larger organizations. To add users to Grafana at scale, you can use the Grafana's `auto_sign_up`configuration to auto-signup users as they log in:

```ini
[auth]
signout_redirect_url = https://grafana.localhost.pomerium.io/.pomerium/sign_out
[auth.jwt]
enabled = true
header_name = X-Pomerium-Jwt-Assertion
email_claim = email
jwk_set_url = https://auth.localhost.pomerium.io/.well-known/pomerium/jwks.json
cache_ttl = 60m
username_claim = sub ;sets the username to the value of the "sub" claim
auto_sign_up = true ;sets the login to automatically create a new user if one doesn't exist
[users]
auto_assign_org = true ;auto assigns the user to the existing default organization
auto_assign_org_role = Editor ;auto assigns the user the "Editor" role
```

Note that the value of `auto_assign_org_role` could also be "Admin" or "Viewer".

This will automatically create a user with their email and username populated. To have the "Name" field populated for users, you can set the `jwt_claims_headers` option in Pomerium to include `name` in the JWT payload:

<Tabs>
<TabItem value="config.yaml" label="config.yaml">

```yaml
jwt_claims_headers: name
```

</TabItem>
<TabItem value="Environment Variable" label="Environment Variable">

```bash
JWT_CLAIMS_HEADERS=name
```

</TabItem>
<TabItem value="Pomerium Ingress Controller" label="Pomerium Ingress Controller">

```yaml
extraEnv:
  JWT_CLAIMS_HEADERS: name
```

</TabItem>
</Tabs>

This configuration will allow seamless authentication and authorization without any additional toil for your team.

:::tip Tip for Google Users When using Google as an IdP, the user field is populated by a numeric value that you can not configure. Note that Grafana can accept the `name` field as a username, including spaces:

```abnf
username_claim = name
```

:::

## Troubleshooting

### Local Signing Key

In instances where Grafana cannot get the signing key for the JWTs from the Pomerium authenticate service, you can place a copy of the key locally.

For example, wildcard certificates signed by LetsEncrypt may still be cross-signed by the [expired DST R3 root]. While many browsers still trust these certificates (as long as they are also signed by a valid root), some applications reject them, including Grafana:

```log
logger=context error=Get "https://authenticate.localhost.pomerium.io/.well-known/pomerium/jwks.json": x509: certificate signed by unknown authority
```

To circumvent this issue, you can use `curl` or `wget` to download the signing key locally:

<Tabs>
<TabItem value="curl" label="curl">

From the Grafana host:

```bash
curl https://authenticate.localhost.pomerium.io/.well-known/pomerium/jwks.json > /etc/grafana/jwks.json
```

</TabItem>
<TabItem value="wget" label="wget">

From the Grafana host:

```bash
wget -O /etc/grafana/jwks.json https://authenticate.localhost.pomerium.io/.well-known/pomerium/jwks.json
```

</TabItem>
</Tabs>

Edit `grafana.ini` and add the `jwk_set_file` key to provide it to Grafana:

```ini
[auth.jwt]
enabled = true
header_name = X-Pomerium-Jwt-Assertion
email_claim = email
jwk_set_file = /etc/grafana/jwks.json
cache_ttl = 60m
```

[`authenticate_service_url`]: /docs/reference/authenticate-service-url
[expired dst r3 root]: https://letsencrypt.org/docs/dst-root-ca-x3-expiration-september-2021/
[global users]: https://grafana.com/docs/grafana/latest/http_api/admin/#global-users
[ingress-cert-manager]: /docs/deploying/k8s/ingress.md#cert-manager-integration
[JWT authentication]: https://grafana.com/docs/grafana/v9.0/setup-grafana/configure-security/configure-authentication/jwt/
[Identity Verification]: /docs/capabilities/getting-users-identity
[quick-start]: /docs/quickstart
